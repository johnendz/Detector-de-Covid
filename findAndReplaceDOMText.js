!function(e,t){"object"==typeof module&&module.exports?module.exports=t():"function"==typeof define&&define.amd?define(t):e.findAndReplaceDOMText=t()}(this,function(){var i="retain",o="first",g=document,d={}.hasOwnProperty;function a(){return function(e,t,n,r,i){if(t&&!t.nodeType&&arguments.length<=2)return!1;var o="function"==typeof n;o&&(n=function(n){return function(e,t){return n(e.text,t.startIndex)}}(n));var d=s(t,{find:e,wrap:o?null:n,replace:o?n:"$"+(r||"&"),prepMatch:function(e,t){if(!e[0])throw"findAndReplaceDOMText cannot handle zero-length matches";if(0<r){var n=e[r];e.index+=e[0].indexOf(n),e[0]=n}return e.endIndex=e.index+e[0].length,e.startIndex=e.index,e.index=t,e},filterElements:i});return a.revert=function(){return d.revert()},!0}.apply(null,arguments)||s.apply(null,arguments)}function s(e,t){return new n(e,t)}function n(e,t){var n=t.preset&&a.PRESETS[t.preset];if(t.portionMode=t.portionMode||i,n)for(var r in n)d.call(n,r)&&!d.call(t,r)&&(t[r]=n[r]);this.node=e,this.options=t,this.prepMatch=t.prepMatch||this.prepMatch,this.reverts=[],this.matches=this.search(),this.matches.length&&this.processMatches()}return a.NON_PROSE_ELEMENTS={br:1,hr:1,script:1,style:1,img:1,video:1,audio:1,canvas:1,svg:1,map:1,object:1,input:1,textarea:1,select:1,option:1,optgroup:1,button:1},a.NON_CONTIGUOUS_PROSE_ELEMENTS={address:1,article:1,aside:1,blockquote:1,dd:1,div:1,dl:1,fieldset:1,figcaption:1,figure:1,footer:1,form:1,h1:1,h2:1,h3:1,h4:1,h5:1,h6:1,header:1,hgroup:1,hr:1,main:1,nav:1,noscript:1,ol:1,output:1,p:1,pre:1,section:1,ul:1,br:1,li:1,summary:1,dt:1,details:1,rp:1,rt:1,rtc:1,script:1,style:1,img:1,video:1,audio:1,canvas:1,svg:1,map:1,object:1,input:1,textarea:1,select:1,option:1,optgroup:1,button:1,table:1,tbody:1,thead:1,th:1,tr:1,td:1,caption:1,col:1,tfoot:1,colgroup:1},a.PRESETS={prose:{forceContext:a.NON_INLINE_PROSE=function(e){return d.call(a.NON_CONTIGUOUS_PROSE_ELEMENTS,e.nodeName.toLowerCase())},filterElements:function(e){return!d.call(a.NON_PROSE_ELEMENTS,e.nodeName.toLowerCase())}}},(a.Finder=n).prototype={search:function(){var o,d=0,a=0,s=this.options.find,e=this.getAggregateText(),p=[],h=this;return s="string"==typeof s?RegExp(String(s).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1"),"g"):s,function e(t){for(var n=0,r=t.length;n<r;++n){var i=t[n];if("string"==typeof i){if(s.global)for(;o=s.exec(i);)p.push(h.prepMatch(o,d++,a));else(o=i.match(s))&&p.push(h.prepMatch(o,0,a));a+=i.length}else e(i)}}(e),p},prepMatch:function(e,t,n){if(!e[0])throw new Error("findAndReplaceDOMText cannot handle zero-length matches");return e.endIndex=n+e.index+e[0].length,e.startIndex=n+e.index,e.index=t,e},getAggregateText:function(){var o=this.options.filterElements,d=this.options.forceContext;return function e(t){if(t.nodeType===Node.TEXT_NODE)return[t.data];if(o&&!o(t))return[];var n=[""];var r=0;if(t=t.firstChild)do{if(t.nodeType!==Node.TEXT_NODE){var i=e(t);d&&t.nodeType===Node.ELEMENT_NODE&&(!0===d||d(t))?(n[++r]=i,n[++r]=""):("string"==typeof i[0]&&(n[r]+=i.shift()),i.length&&(n[++r]=i,n[++r]=""))}else n[r]+=t.data}while(t=t.nextSibling);return n}(this.node)},processMatches:function(){var e,t,n,r=this.matches,i=this.node,o=this.options.filterElements,d=[],a=i,s=r.shift(),p=0,h=0,l=[i];e:for(;;){if(a.nodeType===Node.TEXT_NODE&&(!t&&a.length+p>=s.endIndex?t={node:a,index:h++,text:a.data.substring(s.startIndex-p,s.endIndex-p),indexInMatch:0===p?0:p-s.startIndex,indexInNode:s.startIndex-p,endIndexInNode:s.endIndex-p,isEnd:!0}:e&&d.push({node:a,index:h++,text:a.data,indexInMatch:p-s.startIndex,indexInNode:0}),!e&&a.length+p>s.startIndex&&(e={node:a,index:h++,indexInMatch:0,indexInNode:s.startIndex-p,endIndexInNode:s.endIndex-p,text:a.data.substring(s.startIndex-p,s.endIndex-p)}),p+=a.data.length),n=a.nodeType===Node.ELEMENT_NODE&&o&&!o(a),e&&t){if(a=this.replaceMatch(s,e,d,t),p-=t.node.data.length-t.endIndexInNode,t=e=null,d=[],h=0,!(s=r.shift()))break}else if(!n&&(a.firstChild||a.nextSibling)){a=a.firstChild?(l.push(a),a.firstChild):a.nextSibling;continue}for(;;){if(a.nextSibling){a=a.nextSibling;break}if((a=l.pop())===i)break e}}},revert:function(){for(var e=this.reverts.length;e--;)this.reverts[e]();this.reverts=[]},prepareReplacementString:function(e,t,r){var n=this.options.portionMode;return n===o&&0<t.indexInMatch?"":(e=e.replace(/\$(\d+|&|`|')/g,function(e,t){var n;switch(t){case"&":n=r[0];break;case"`":n=r.input.substring(0,r.startIndex);break;case"'":n=r.input.substring(r.endIndex);break;default:n=r[+t]||""}return n}),n===o?e:t.isEnd?e.substring(t.indexInMatch):e.substring(t.indexInMatch,t.indexInMatch+t.text.length))},getPortionReplacementNode:function(e,t){var n=this.options.replace||"$&",r=this.options.wrap,i=this.options.wrapClass;if(r&&r.nodeType){var o=g.createElement("div");o.innerHTML=r.outerHTML||(new XMLSerializer).serializeToString(r),r=o.firstChild}if("function"==typeof n)return(n=n(e,t))&&n.nodeType?n:g.createTextNode(String(n));var d="string"==typeof r?g.createElement(r):r;return d&&i&&(d.className=i),(n=g.createTextNode(this.prepareReplacementString(n,e,t))).data&&d?(d.appendChild(n),d):n},replaceMatch:function(e,t,n,r){var i,o,d=t.node,a=r.node;if(d===a){var s=d;0<t.indexInNode&&(i=g.createTextNode(s.data.substring(0,t.indexInNode)),s.parentNode.insertBefore(i,s));var p=this.getPortionReplacementNode(r,e);return s.parentNode.insertBefore(p,s),r.endIndexInNode<s.length&&(o=g.createTextNode(s.data.substring(r.endIndexInNode)),s.parentNode.insertBefore(o,s)),s.parentNode.removeChild(s),this.reverts.push(function(){i===p.previousSibling&&i.parentNode.removeChild(i),o===p.nextSibling&&o.parentNode.removeChild(o),p.parentNode.replaceChild(s,p)}),p}i=g.createTextNode(d.data.substring(0,t.indexInNode)),o=g.createTextNode(a.data.substring(r.endIndexInNode));for(var h=this.getPortionReplacementNode(t,e),l=[],c=0,f=n.length;c<f;++c){var u=n[c],x=this.getPortionReplacementNode(u,e);u.node.parentNode.replaceChild(x,u.node),this.reverts.push(function(e,t){return function(){t.parentNode.replaceChild(e.node,t)}}(u,x)),l.push(x)}var N=this.getPortionReplacementNode(r,e);return d.parentNode.insertBefore(i,d),d.parentNode.insertBefore(h,d),d.parentNode.removeChild(d),a.parentNode.insertBefore(N,a),a.parentNode.insertBefore(o,a),a.parentNode.removeChild(a),this.reverts.push(function(){i.parentNode.removeChild(i),h.parentNode.replaceChild(d,h),o.parentNode.removeChild(o),N.parentNode.replaceChild(a,N)}),N}},a});